<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eight Pharmacy Product Info</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* 스타일은 이전과 100% 동일합니다 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f9f9f9; color: #333; max-width: 600px; margin: 0 auto; padding-bottom: 50px; }
        header { background: #fff; padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        header h1 { font-size: 1.2rem; color: #1D5C36; font-weight: 800; cursor: pointer; }
        .product-img-box { width: 100%; height: 350px; background-color: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .product-img-box img { width: 100%; height: 100%; object-fit: contain; }
        .product-info { padding: 20px; background: #fff; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .product-name { font-size: 1.4rem; font-weight: 700; margin-bottom: 10px; line-height: 1.3; }
        .price-container { display: flex; flex-direction: column; gap: 5px; }
        .product-price { font-size: 1.8rem; color: #d32f2f; font-weight: 800; }
        .currency { font-size: 1rem; color: #555; font-weight: normal; }
        
        .converted-info-box {
            background-color: #f0f7f4; 
            padding: 10px;
            border-radius: 6px;
            margin-top: 5px;
            display: none; 
            border-left: 4px solid #1D5C36;
        }
        .converted-price { font-size: 1.4rem; color: #1D5C36; font-weight: 700; margin-bottom: 4px; }
        .rate-detail { font-size: 0.85rem; color: #666; display: block; }
        .rate-date { font-size: 0.75rem; color: #999; margin-top: 2px; display: block; }

        .lang-tabs { display: flex; justify-content: space-around; background: #fff; padding: 10px 5px; margin-bottom: 2px; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .lang-btn { border: none; background: none; cursor: pointer; opacity: 0.4; transition: all 0.2s; padding: 5px 10px; border-bottom: 3px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .lang-btn.active { opacity: 1; transform: scale(1.1); border-bottom: 3px solid #1D5C36; }
        .flag-icon { width: 32px; height: auto; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .lang-label { font-size: 0.8rem; color: #666; font-weight: bold; }
        .description-container { background: #fff; min-height: 300px; padding: 20px; }
        .desc-content { display: none; }
        .desc-content.active { display: block; animation: fadeIn 0.3s; }
        .desc-text { font-size: 1rem; line-height: 1.7; color: #444; white-space: pre-line; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loading { text-align: center; padding: 50px; font-weight: bold; color: #666; display: none; }
    </style>
</head>
<body>

    <header>
        <h1 onclick="location.href='index.html'">EIGHT PHARMACY</h1>
    </header>

    <div id="loading">상품 정보를 불러오는 중...</div>

    <div id="content" style="display:none;">
        <div class="product-img-box">
            <img src="" alt="Product Image" id="mainImage">
        </div>

        <div class="product-info">
            <div class="product-name" id="pName"></div>
            
            <div class="price-container">
                <div class="product-price">
                    <span id="pPrice">0</span> <span class="currency">KRW</span>
                </div>

                <div id="convertBox" class="converted-info-box">
                    <div id="convertPrice" class="converted-price"></div>
                    <span id="convertRate" class="rate-detail"></span>
                    <span id="convertDate" class="rate-date"></span>
                </div>
            </div>
        </div>

        <div class="lang-tabs">
            <button class="lang-btn active" onclick="changeLang('kr')">
                <img src="./images/flag-kr.png" alt="Korea" class="flag-icon">
                <span class="lang-label">KOR</span>
            </button>
            <button class="lang-btn" onclick="changeLang('en')">
                <img src="./images/flag-en.png" alt="USA" class="flag-icon">
                <span class="lang-label">ENG</span>
            </button>
            <button class="lang-btn" onclick="changeLang('cn')">
                <img src="./images/flag-cn.png" alt="China" class="flag-icon">
                <span class="lang-label">CHN</span>
            </button>
            <button class="lang-btn" onclick="changeLang('jp')">
                <img src="./images/flag-jp.png" alt="Japan" class="flag-icon">
                <span class="lang-label">JPN</span>
            </button>
        </div>

        <div class="description-container">
            <div id="desc-kr" class="desc-content active">
                <h3>상세정보</h3><p class="desc-text"></p>
            </div>
            <div id="desc-en" class="desc-content">
                <h3>Description</h3><p class="desc-text"></p>
            </div>
            <div id="desc-cn" class="desc-content">
                <h3>详细信息</h3><p class="desc-text"></p>
            </div>
            <div id="desc-jp" class="desc-content">
                <h3>詳細情報</h3><p class="desc-text"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCygpc_WS2_35_8eYgdTEJwZCtNGJjHvY4",
            authDomain: "pharmacy-productlist.firebaseapp.com",
            projectId: "pharmacy-productlist",
            storageBucket: "pharmacy-productlist.firebasestorage.app",
            messagingSenderId: "409677826366",
            appId: "1:409677826366:web:dc825470ef673194e2446f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        let globalRates = null; 
        let globalPriceKRW = 0;
        let rateDate = "";

        async function loadProduct() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');

            if (!productId) {
                loading.innerText = "잘못된 접근입니다.";
                loading.style.display = 'block';
                return;
            }
            loading.style.display = 'block';

            try {
                await fetchRates();

                const docRef = doc(db, "products", productId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('pName').innerText = data.name;
                    globalPriceKRW = Number(data.price);
                    document.getElementById('pPrice').innerText = globalPriceKRW.toLocaleString();
                    document.getElementById('mainImage').src = data.image ? data.image : "./images/sample-product.jpg";

                    document.querySelector('#desc-kr .desc-text').innerText = data.desc_kr || "설명이 없습니다.";
                    document.querySelector('#desc-en .desc-text').innerText = data.desc_en || "No description.";
                    document.querySelector('#desc-cn .desc-text').innerText = data.desc_cn || "没有说明。";
                    document.querySelector('#desc-jp .desc-text').innerText = data.desc_jp || "説明がありません。";

                    loading.style.display = 'none';
                    content.style.display = 'block';
                } else {
                    loading.innerText = "등록되지 않은 상품입니다.";
                }
            } catch (error) {
                console.error("Error:", error);
                loading.innerText = "오류 발생: " + error.message;
            }
        }

        async function fetchRates() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/KRW');
                const data = await response.json();
                globalRates = data.rates; 
                rateDate = data.date; 
            } catch (err) {
                console.log("환율 로드 실패");
            }
        }

        window.changeLang = function(lang) {
            document.querySelectorAll('.desc-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('desc-' + lang).classList.add('active');
            
            const btns = document.querySelectorAll('.lang-btn');
            if(lang === 'kr') btns[0].classList.add('active');
            if(lang === 'en') btns[1].classList.add('active');
            if(lang === 'cn') btns[2].classList.add('active');
            if(lang === 'jp') btns[3].classList.add('active');

            const box = document.getElementById('convertBox');
            const priceTxt = document.getElementById('convertPrice');
            const rateTxt = document.getElementById('convertRate');
            const dateTxt = document.getElementById('convertDate');

            if (!globalRates || lang === 'kr') {
                box.style.display = 'none';
                return;
            }

            box.style.display = 'block';

            let targetRate = 0;
            let currencyCode = "";
            let symbol = "";
            let convertedPrice = 0;

            if (lang === 'en') {
                targetRate = globalRates.USD;
                currencyCode = "USD";
                symbol = "$";
                convertedPrice = (globalPriceKRW * targetRate).toFixed(2);
            } else if (lang === 'cn') {
                targetRate = globalRates.CNY;
                currencyCode = "CNY";
                symbol = "¥";
                convertedPrice = (globalPriceKRW * targetRate).toFixed(1);
            } else if (lang === 'jp') {
                targetRate = globalRates.JPY;
                currencyCode = "JPY";
                symbol = "円";
                convertedPrice = (globalPriceKRW * targetRate).toFixed(0);
            }

            // 가격 표시
            if(lang === 'jp') {
                priceTxt.innerText = convertedPrice + symbol; 
            } else {
                priceTxt.innerText = symbol + convertedPrice;
            }

            // ✅ 환율 상세 정보 (엔화만 100단위 처리)
            let baseUnit = "1";
            let reverseRate = (1 / targetRate);

            if (currencyCode === "JPY") {
                baseUnit = "100"; // 엔화는 100을 기준으로
                reverseRate = reverseRate * 100; // 값도 100배
            }

            // 소수점 2자리로 깔끔하게 정리
            let finalRateStr = reverseRate.toFixed(2);
            
            rateTxt.innerText = `Applied Rate: ${baseUnit} ${currencyCode} ≈ ${finalRateStr} KRW`;
            dateTxt.innerText = `Updated: ${rateDate}`;
        }

        loadProduct();
    </script>

</body>
</html>