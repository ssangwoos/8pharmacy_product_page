<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장부 상세 조회</title>
    <link rel="stylesheet" href="common.css">       <link rel="stylesheet" href="style-ledger.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<header>
    <a href="index.html" class="logo">
        <i class="fas fa-capsules"></i> <span class="pharmacy-name-display"></span>
    </a>
    <nav class="nav-links">
        <a href="index.html" class="menu-btn">홈</a>
        <a href="write.html" class="menu-btn">명세서 입력</a>
        <a href="ledger.html" class="menu-btn">장부</a>
        <a href="settings.html" class="menu-btn">설정</a>
    </nav>
</header>

<div class="container">
    
    <main class="ledger-wrapper">
        
        <div class="ledger-paper">

            <div class="ledger-header-control">
                <div class="filter-group" style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <select id="vendorFilter" onchange="filterLedger()" 
                            style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 220px; font-size: 0.9rem;">
                        <option value="all">전체 거래처</option>
                    </select>
                    
                    <div class="date-range-picker" style="display:inline-flex; align-items:center; gap:5px;">
                        <input type="date" id="startDate" onchange="filterLedger()">
                        <span>~</span>
                        <input type="date" id="endDate" onchange="filterLedger()">
                    </div>

                    <div class="search-container" style="display: inline-flex; align-items: center; gap: 10px;">
                        <input type="text" id="searchInput" placeholder="거래처 또는 품목명 검색" 
                            onkeyup="renderLedger()" 
                            style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; width: 250px;">
                        
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 0.85rem; color: #475569; cursor: pointer; white-space: nowrap; background: #f8fafc; padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px;">
                            <input type="checkbox" id="totalBalanceFullMode" onchange="renderLedger()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span>전체기간 누적잔액</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="ledger-summary-bar">
                <div class="summary-item blue">
                    <span>총 매입액 (입고)</span>
                    <strong id="sumBuy" class="val-blue">0</strong>
                </div>
                <div class="summary-item red">
                    <span>총 결제액 (지출)</span>
                    <strong id="sumPay" class="val-red">0</strong>
                </div>
                <div class="summary-item green">
                    <span>현재 잔액 (최종)</span>
                    <strong id="sumBalance" class="val-green">0</strong>
                </div>
            </div>

            <div class="table-container-card">
                <table class="data-grid" id="ledgerTable">
                    <colgroup>
                        <col style="width: 170px;"> <col style="width: 80px;">  <col style="width: 110px;"> 
                        
                        <col style="width: auto;">  
                        
                        <col style="width: 70px;">  <col style="width: 100px;"> <col style="width: 90px;">  <col style="width: 110px;"> <col style="width: 110px;"> <col style="width: 110px;"> <col style="width: 50px;">  <col style="width: 90px;">  
                        </colgroup>
                   <thead>
                        <tr>
                            <th style="width: 100px; text-align: center;">날짜</th> <th style="width: 60px; text-align: center;">구분</th>
                            <th style="width: 120px; text-align: center;">거래처</th>
                            <th style="min-width: 250px; text-align: center;">적요(메모)</th> <th style="width: 50px; text-align: center;">수량</th>
                            <th style="width: 90px; text-align: center;">공급가</th>
                            <th style="width: 80px; text-align: center;">세액</th>
                            <th style="width: 100px; text-align: center;">입고액</th>
                            <th style="width: 100px; text-align: center;">지출/반품</th>
                            <th style="width: 110px; text-align: center;">잔액</th>
                            <th style="width: 45px; text-align: center;">증빙</th>
                            <th style="width: 60px; text-align: center;">관리</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerTableBody">
                        <tr><td colspan="12" class="text-center" style="padding:50px; color:#999;">데이터를 불러오는 중...</td></tr>
                    </tbody>
                    <tfoot>
                        <tr class="entry-row">
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-bolt" style="color:#f59f00; font-size:1.1rem; animation: pulse 2s infinite;"></i>
                                    <input type="date" id="qDate" style="flex:1; text-align: center;">
                                </div>
                            </td>
                            <td style="width: 70px;">
                                <select id="qType" onchange="toggleQuickPayment()">
                                    <option value="buy">입고</option>
                                    <option value="pay">결제</option>
                                    <option value="return">반품</option>
                                </select>
                            </td>
                            <td style="width: 120px;"><input type="text" id="qVendor" placeholder="거래처" list="vendorList"></td>
                            
                            <td style="min-width: 250px;"><input type="text" id="qMemo" placeholder="내용(적요)" style="width: 100%;"></td>
                            
                            <td style="width: 60px;"><input type="number" id="qQty" placeholder="0"></td>
                            <td style="width: 90px;"><input type="text" id="qSupply" class="money-input" placeholder="공급가" onkeyup="formatCurrency(this); calcQuickSupply();"></td>
                            <td style="width: 80px;"><input type="text" id="qVat" class="money-input" placeholder="세액" onkeyup="formatCurrency(this); calcQuickVat();"></td>
                            <td style="width: 100px;"><input type="text" id="qTotal" class="money-input" placeholder="합계" onkeyup="formatCurrency(this); calcQuickTotalReverse();" style="font-weight:bold; color:#2563eb;"></td>
                            
                            <td colspan="3" style="background:transparent;"></td>
                            <td>
                                <button class="btn-quick-add" onclick="addQuickItem()">
                                    <i class="fas fa-plus"></i> 추가
                                </button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div id="paginationControls" class="pagination-container"></div>
        </div> </main>
</div>
        

<div id="editModal">
    <div class="modal-new-box"> <h3 style="margin-top:0; border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-bottom:25px;">📋 내역 상세 수정</h3>
        
        <input type="hidden" id="editDocId">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr 1.5fr; gap:15px; margin-bottom:20px;">
            <div><label style="display:block; font-size:0.8rem; margin-bottom:5px;">날짜</label>
                 <input type="date" id="editDate" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></div>
            <div><label style="display:block; font-size:0.8rem; margin-bottom:5px;">구분</label>
                 <select id="editType" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; background:white;">
                    <option value="buy">입고(매입)</option>
                    <option value="pay">결제(지불)</option>
                    <option value="return">반품</option>
                 </select></div>
            <div><label style="display:block; font-size:0.8rem; margin-bottom:5px;">거래처</label>
                 <input type="text" id="editVendor" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></div>
        </div>

        <div style="margin-bottom:25px;">
            <label style="display:block; font-size:0.8rem; margin-bottom:5px;">적요(메모)</label>
            <input type="text" id="editMemo" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
        </div>

        <div class="split-amount-row">
            <div><label>수량</label><input type="number" id="editQty" style="text-align:center !important;"></div>
            <div><label>공급가</label><input type="text" id="editSupply" oninput="onEditSupplyInput(this)"></div>
            <div><label>세액</label><input type="text" id="editVat" oninput="onEditVatInput(this)"></div>
            <div><label style="color:#2563eb;">합계(입고액)</label>
                 <input type="text" id="editTotalDisplay" oninput="onEditTotalInput(this)" style="border:2px solid #2563eb !important; color:#2563eb !important; font-weight:bold !important;"></div>
        </div>

        <div style="margin-top:35px; display:flex; gap:15px;">
            <button onclick="saveEdit()" style="flex:1.5; background:#2563eb; color:white; padding:16px; border-radius:10px; border:none; font-weight:bold; cursor:pointer;">변경사항 저장</button>
            <button onclick="closeEditModal()" style="flex:1; background:#f1f5f9; padding:16px; border-radius:10px; border:none; cursor:pointer;">취소</button>
        </div>
    </div>
</div>

<div id="groupTooltip" style="
    display: none; 
    position: fixed; 
    background: #1e293b; 
    color: white; 
    padding: 8px 12px; 
    border-radius: 6px; 
    font-size: 13px; 
    font-weight: bold; 
    z-index: 9999; 
    pointer-events: none;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
</div>
<script src="firebase-config.js"></script>
<script src="logic-ledger.js"></script>

</body>
</html>